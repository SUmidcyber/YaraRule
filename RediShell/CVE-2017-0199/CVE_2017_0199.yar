rule Excel_Embedded_OLE_Malware_CVE_Related
{
    meta:
        description = "Excel OLE Embedded Object with CVE patterns detection"
        author = "Malware Analysis Team"
        date = "2025-10-21"
        threat_level = "High"
        reference = "CVE-2017-0199, CVE-2017-8570, CVE-2018-8174"
        
    strings:
        // Excel File Signature
        $xls_header = { D0 CF 11 E0 A1 B1 1A E1 }
        
        // OLE Root Entry patterns
        $root_entry = "Root Entry" wide ascii
        $vba_project = "_VBA_PROJECT_CUR" wide ascii
        $workbook = "Workbook" wide ascii
        
        // Embedded OLE Object patterns
        $embedded_ole = "MBD00931C" wide ascii
        $comp_obj = "CompObj" wide ascii
        $std_ole_link = "StdOleLink" wide ascii
        
        // CVE Related Hex Patterns
        $cve_2017_0199_hex = { 00 00 02 08 19 }
        $cve_2017_8570_hex = { 00 00 00 00 0F }
        $cve_2018_8174_hex = { 00 02 08 20 }
        
        // Suspicious metadata
        $excel_sheet_8 = "Excel.Sheet.8" wide ascii
        $biff8 = "Biff8" wide ascii
        
        // Hex strings from analysis
        $hex_string1 = { 00 02 08 19 }
        $hex_string2 = { 00 00 00 00 0F }
        $hex_string3 = { 00 02 08 20 }
        
        // Author/creator anomalies
        $suspicious_author = "Tanya Bansal-v" wide ascii
        $suspicious_id = "91974" wide ascii
        
    condition:
        // Excel file signature check
        $xls_header at 0 and
        
        // Multiple OLE structure indicators
        ( 
            ( 
                // Root structure requirements
                $root_entry and 
                $vba_project and 
                $workbook 
            ) and
            (
                // Embedded object detection
                $embedded_ole or
                $std_ole_link
            ) and
            (
                // CVE pattern matches
                (2 of ($cve_2017_0199_hex, $cve_2017_8570_hex, $cve_2018_8174_hex)) or
                (2 of ($hex_string1, $hex_string2, $hex_string3)) or
                
                // Metadata anomalies
                ($suspicious_author and $suspicious_id) or
                
                // Multiple technical indicators
                ($comp_obj and $excel_sheet_8 and $biff8)
            )
        )
}

rule Excel_OLE_CVE_Exploit_Indicator
{
    meta:
        description = "Specific CVE exploit patterns in Excel OLE objects"
        severity = "Critical"
        
    strings:
        // CVE-2017-0199 specific patterns
        $cve_2017_0199_rtf = { 7B 5C 72 74 66 31 }  // RTF header
        $cve_2017_0199_scriptlet = "scriptlet" wide ascii
        
        // CVE-2017-8570 patterns
        $cve_2017_8570_suspicious = { 00 00 04 80 }
        
        // CVE-2018-8174 VBScript patterns
        $vbscript_include = "VBScript" wide ascii
        $classid_pattern = "00000300-0000-0000-C000-000000000046" wide ascii
        
        // Network call patterns
        $http_pattern = "http://" wide ascii
        $powershell_pattern = "powershell" wide ascii nocase
        $cmd_pattern = "cmd.exe" wide ascii
        
    condition:
        // Excel file with CVE exploit patterns
        uint16(0) == 0xCFD0 and  // Excel signature
        (
            (2 of ($cve_2017_0199_rtf, $cve_2017_0199_scriptlet)) or
            ($cve_2017_8570_suspicious in (0..1000)) or
            ($classid_pattern and $vbscript_include) or
            ($http_pattern and ($powershell_pattern or $cmd_pattern))
        )
}

rule Excel_Time_Stomping_Anomaly
{
    meta:
        description = "Excel file with time stomping and version anomalies"
        
    strings:
        $excel_2003_creator = "Microsoft Excel 2003" wide ascii
        $recent_date = "2025" wide ascii
        $old_date = "2006" wide ascii
        $version_anomaly = "Version 6.2" wide ascii  // Windows 8 version with Excel 2003
        
    condition:
        all of them and
        filesize > 500KB and  // Unusually large for Excel 2003 file
        filesize < 2MB
}

// Composite rule for high-confidence detection
rule High_Confidence_Excel_Embedded_Malware
{
    meta:
        description = "High confidence detection for Excel embedded malware"
        confidence = "90"
        
    condition:
        (
            Excel_Embedded_OLE_Malware_CVE_Related and
            filesize > 1000000  // Over 1MB - suspicious for Excel 97-2003
        ) or
        (
            Excel_OLE_CVE_Exploit_Indicator and 
            Excel_Time_Stomping_Anomaly
        )
}